<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>技术沉淀 - 云栖思渊</title>
    <link rel="stylesheet" href="styles/main.css">
    <link rel="stylesheet" href="styles/header.css">
    <link rel="stylesheet" href="styles/footer.css">
    <style>
        /* 主内容区域样式优化 */
        .main-content {
            display: grid;
            grid-template-columns: 360px 1fr;
            gap: 40px;
            max-width: 1600px;
            margin: 0 auto;
            padding: 100px 40px 40px;
            min-height: calc(100vh - 60px);
            position: relative;
            z-index: 1;
        }

        /* 左侧栏样式优化 */
        .left-column {
            background: #ffffff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.05);
            position: sticky;
            top: 80px;
            max-height: calc(100vh - 100px);
            overflow-y: auto;
            width: 100%;
        }

        /* 滚动条样式优化 */
        .left-column::-webkit-scrollbar {
            width: 6px;
        }
        .left-column::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        .left-column::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 3px;
        }
        .left-column::-webkit-scrollbar-thumb:hover {
            background: #999;
        }

        /* 文章列表样式优化 */
        #article-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .article-list-item {
            cursor: pointer;
            padding: 15px 20px;
            transition: all 0.3s ease;
            border-radius: 12px;
            margin-bottom: 10px;
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            font-size: 15px;
            line-height: 1.5;
            color: #334155;
        }
        .article-list-item:hover {
            color: #93C5FD;
            background-color: #fff;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            transform: translateY(-2px);
            border-color: #93C5FD;
        }
        .article-list-item.active {
            color: #93C5FD;
            font-weight: 500;
            background-color: #fff;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            border-color: #93C5FD;
        }

        /* 右侧文章内容区域样式优化 */
        .right-column {
            background: #ffffff;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.05);
            width: 100%;
        }
        .article-content {
            margin-top: 0;
            padding: 0;
            background: transparent;
            box-shadow: none;
        }
        .article-title {
            margin-bottom: 30px;
            color: #2c3e50;
            font-size: 2em;
            font-weight: 600;
            line-height: 1.4;
            border-bottom: 2px solid #93C5FD;
            padding-bottom: 15px;
        }
        .article-body {
            line-height: 1.8;
            color: #334155;
            font-size: 16px;
        }
        .article-body p {
            margin-bottom: 1.5em;
            color: #334155;
        }
        .article-body h1, .article-body h2, .article-body h3 {
            margin: 2em 0 1em;
            color: #2c3e50;
            font-weight: 600;
            line-height: 1.4;
        }
        .article-body h1 {
            font-size: 1.8em;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 0.5em;
        }
        .article-body h2 {
            font-size: 1.5em;
        }
        .article-body h3 {
            font-size: 1.25em;
        }
        .article-body code {
            background: #f6f8fa;
            padding: 3px 6px;
            border-radius: 4px;
            font-family: 'SF Mono', Menlo, Monaco, Consolas, monospace;
            font-size: 0.9em;
            color: #476582;
        }
        .article-body pre code {
            display: block;
            padding: 20px;
            overflow-x: auto;
            line-height: 1.6;
            background: #282c34;
            color: #abb2bf;
            border-radius: 8px;
            margin: 1.5em 0;
        }
        .article-body a {
            color: #93C5FD;
            text-decoration: none;
            transition: color 0.3s ease;
        }
        .article-body a:hover {
            color: #60A5FA;
            text-decoration: underline;
        }
        .article-body ul, .article-body ol {
            padding-left: 1.5em;
            margin-bottom: 1.5em;
        }
        .article-body li {
            margin-bottom: 0.5em;
        }
        .article-body blockquote {
            margin: 1.5em 0;
            padding: 1em 1.5em;
            border-left: 4px solid #93C5FD;
            background: #f8fafc;
            border-radius: 4px;
            color: #475569;
        }
        .article-body img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin: 1.5em 0;
        }

        /* 加载状态样式优化 */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            background: #f8fafc;
            border-radius: 12px;
            margin: 20px 0;
            border: 1px solid #e2e8f0;
        }
        .loading-spinner {
            width: 24px;
            height: 24px;
            border: 2px solid #e2e8f0;
            border-top: 2px solid #93C5FD;
            border-radius: 50%;
            margin-right: 12px;
        }
        .loading span {
            color: #64748b;
            font-size: 15px;
        }

        /* 响应式布局优化 */
        @media (max-width: 1200px) {
            .main-content {
                max-width: 100%;
                padding: 80px 20px 20px;
                gap: 20px;
            }
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
                padding: 80px 15px 20px;
            }
            .left-column {
                position: relative;
                top: 0;
                max-height: none;
                margin-bottom: 20px;
                padding: 20px;
            }
            .right-column {
                padding: 20px;
            }
            .article-title {
                font-size: 1.5em;
            }
        }

        .article-body {
            line-height: 1.8;
            color: #333;
            font-size: 16px;
        }
        .article-body p {
            margin-bottom: 1.2em;
        }
        .article-body h1, .article-body h2, .article-body h3 {
            margin: 1.5em 0 1em;
            color: #2c3e50;
        }
        .article-body code {
            background: #f6f8fa;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.9em;
        }
        .article-body pre code {
            display: block;
            padding: 16px;
            overflow-x: auto;
            line-height: 1.6;
            background: #282c34;
            color: #abb2bf;
            border-radius: 6px;
        }
        .loading-spinner {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #93C5FD;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
            vertical-align: middle;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 30px;
            color: #666;
            background: #f8f9fa;
            border-radius: 8px;
            margin: 20px 0;
        }
        .status-message {
            padding: 10px 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            animation: fadeIn 0.3s ease;
        }
        .status-message.error {
            background-color: #fee2e2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }
        .status-message.success {
            background-color: #dcfce7;
            color: #16a34a;
            border: 1px solid #bbf7d0;
        }
        .status-message.info {
            background-color: #e0f2fe;
            color: #0284c7;
            border: 1px solid #bae6fd;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .todo {
            display: flex;
            align-items: center;
            margin: 8px 0;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        .todo input[type="checkbox"] {
            margin-right: 10px;
        }
        .image-placeholder {
            padding: 20px;
            background: #f8f9fa;
            border: 2px dashed #ddd;
            border-radius: 8px;
            text-align: center;
            color: #666;
        }
        details {
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
        }
        summary {
            cursor: pointer;
            padding: 8px;
            font-weight: bold;
            color: #2c3e50;
        }
        details[open] summary {
            margin-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }
        /* 调试开关样式优化 */
        .debug-toggle {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px 15px;
            background: #ffffff;
            border-radius: 8px;
            cursor: pointer;
            user-select: none;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            border: 1px solid #e5e7eb;
            transition: all 0.3s ease;
        }
        .debug-toggle:hover {
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
            border-color: #d1d5db;
        }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
            margin-right: 12px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #e5e7eb;
            transition: .3s ease-in-out;
            border-radius: 24px;
            border: 1px solid #d1d5db;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .3s ease-in-out;
            border-radius: 50%;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .toggle-switch input:checked + .toggle-slider {
            background-color: #93C5FD;
            border-color: #93C5FD;
        }
        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(20px);
        }
        .toggle-switch input:focus + .toggle-slider {
            box-shadow: 0 0 1px #93C5FD;
        }
        
        /* 调试面板样式优化 */
        #debug-panel {
            display: none;
            margin-bottom: 20px;
            padding: 15px;
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border: 1px solid #e5e7eb;
            animation: slideDown 0.3s ease;
        }
        @keyframes slideDown {
            from { 
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* API配置区域样式优化 */
        #api-config {
            margin-bottom: 15px;
            padding: 15px;
            background-color: #f8fafc !important;
            border: 1px solid #e2e8f0 !important;
            border-radius: 8px !important;
            color: #334155 !important;
        }
        #api-config input {
            width: 100%;
            padding: 8px 12px;
            margin-top: 6px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        #api-config input:focus {
            outline: none;
            border-color: #93C5FD;
            box-shadow: 0 0 0 2px rgba(147,197,253,0.1);
        }
        #update-config-btn {
            padding: 8px 16px !important;
            background: #93C5FD !important;
            color: white !important;
            border: none !important;
            border-radius: 6px !important;
            cursor: pointer !important;
            font-size: 14px !important;
            transition: all 0.3s ease !important;
        }
        #update-config-btn:hover {
            background: #60A5FA !important;
            transform: translateY(-1px);
        }
        
        /* 调试控制按钮样式优化 */
        #debug-controls {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        #debug-controls button {
            padding: 8px 16px !important;
            background: #f8fafc !important;
            color: #334155 !important;
            border: 1px solid #e2e8f0 !important;
            border-radius: 6px !important;
            cursor: pointer !important;
            font-size: 14px !important;
            transition: all 0.3s ease !important;
            flex: 1;
            min-width: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #debug-controls button:hover {
            background: #f1f5f9 !important;
            border-color: #cbd5e1 !important;
            transform: translateY(-1px);
        }
        
        /* 集成指南样式优化 */
        #integration-guide {
            margin-top: 15px;
            padding: 15px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
        }
        #integration-guide h3 {
            margin: 0 0 12px 0;
            color: #334155;
            font-size: 16px;
        }
        #integration-guide ol {
            margin: 0;
            padding-left: 20px;
        }
        #integration-guide li {
            margin-bottom: 8px;
            color: #475569;
            font-size: 14px;
        }
        #integration-guide button {
            margin-top: 12px;
            padding: 6px 12px;
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            color: #475569;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s ease;
        }
        #integration-guide button:hover {
            background: #e2e8f0;
        }
        
        /* 提示文本样式优化 */
        .hint-text {
            font-size: 13px;
            color: #64748b;
            margin-top: 8px;
            line-height: 1.5;
        }
        .hint-text a {
            color: #93C5FD;
            text-decoration: none;
            transition: color 0.3s ease;
        }
        .hint-text a:hover {
            color: #60A5FA;
            text-decoration: underline;
        }

        /* 调试面板中的链接颜色 */
        #show-integration-guide {
            color: #93C5FD !important;
        }
        #show-integration-guide:hover {
            color: #60A5FA !important;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="nav-container">
            <div class="web-title">云栖思渊</div>
            <nav>
                <ul class="nav-menu">
                    <li><a href="index.html">首页</a></li>
                    <li><a href="tech-blog.html">技术沉淀</a></li>
                    <li><a href="/blog">生活点滴</a></li>
                    <li><a href="/contact">联系方式</a></li>
                </ul>
            </nav>
        </div>
    </header>
    <main class="main-content">
        <div class="left-column">
            <h2>文章列表</h2>
            <ul id="article-list">
                <li class="loading">加载中...</li>
            </ul>
            <div id="status-message" style="margin: 15px 0; color: #666;"></div>
            <!-- 调试开关和面板移到文章列表下方 -->
            <div style="margin-top: 30px; border-top: 1px solid #e5e7eb; padding-top: 20px;">
                <div class="debug-toggle" style="opacity: 0.7;">
                    <label class="toggle-switch">
                        <input type="checkbox" id="debug-mode-toggle">
                        <span class="toggle-slider"></span>
                    </label>
                    <span style="font-size: 13px; color: #64748b;">调试模式</span>
                </div>
                <!-- 调试面板样式优化 -->
                <div id="debug-panel" style="display: none; margin-top: 15px;">
                    <div id="api-config" style="margin-bottom: 15px; padding: 12px; background-color: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 13px;">
                        <div style="margin-bottom: 10px;">
                            <label for="database-id">数据库 ID:</label>
                            <input type="text" id="database-id" value="1a932af826e680df8bf7f320b51930b9" style="width: 100%; padding: 6px 10px; margin-top: 5px; font-size: 13px;">
                        </div>
                        <button id="update-config-btn" style="width: 100%; padding: 6px 12px; margin-top: 5px;">更新配置</button>
                        <div style="margin-top: 8px; font-size: 12px; color: #64748b;">
                            <strong>提示：</strong> 遇到 404 错误请确保集成已与数据库共享。
                            <a href="#" id="show-integration-guide" style="color: #93C5FD;">查看帮助</a>
                        </div>
                    </div>
                    <div id="debug-controls" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 15px;">
                        <button id="refresh-btn">刷新列表</button>
                        <button id="debug-btn">数据库信息</button>
                        <button id="test-api-btn">测试API</button>
                        <button id="list-db-btn">所有数据库</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="right-column">
            <div id="article-container">
                <h2 class="article-title">欢迎访问技术沉淀</h2>
                <div class="article-body">
                    <p>请从左侧选择一篇文章阅读。</p>
                </div>
            </div>
        </div>
    </main>

    <script src="api/fetchArticles.js"></script>
    <script>
      // 存储文章数据
      let articlesData = [];
      let currentDatabaseId = '1a932af826e680df8bf7f320b51930b9';
      
      // 显示状态消息
      function showStatus(message, isError = false, type = 'info') {
        const statusEl = document.getElementById('status-message');
        statusEl.textContent = message;
        statusEl.className = `status-message ${type}`;
        
        if (isError) {
            statusEl.className = 'status-message error';
        } else if (type === 'success') {
            statusEl.className = 'status-message success';
        } else {
            statusEl.className = 'status-message info';
        }
      }
      
      // 更新配置
      function updateConfig() {
        const databaseIdInput = document.getElementById('database-id');
        currentDatabaseId = databaseIdInput.value.trim();
        
        if (!currentDatabaseId) {
          showStatus('数据库 ID 不能为空', true);
          return false;
        }
        
        showStatus(`配置已更新，数据库 ID: ${currentDatabaseId}`);
        return true;
      }
      
      async function loadArticles() {
        try {
          const articlesList = document.getElementById('article-list');
          articlesList.innerHTML = `
            <li class="loading">
                <div class="loading-spinner"></div>
                <span>正在加载文章列表...</span>
            </li>`;
          
          const articles = await getArticles(currentDatabaseId);
          console.log('Articles:', articles); // 调试输出
          articlesData = articles; // 存储文章数据
          
          // 清空加载提示
          articlesList.innerHTML = '';
          
          if (articles.length === 0) {
            articlesList.innerHTML = '<li>暂无文章</li>';
            return;
          }
          
          // 添加文章列表
          articles.forEach((article, index) => {
            const listItem = document.createElement('li');
            listItem.className = 'article-list-item';
            listItem.textContent = article.title || '无标题';
            listItem.onclick = () => showArticle(index);
            articlesList.appendChild(listItem);
          });
          
          // 默认显示第一篇文章
          if (articles.length > 0) {
            showArticle(0);
          }
        } catch (error) {
          console.error('Error loading articles:', error);
          const articlesList = document.getElementById('article-list');
          articlesList.innerHTML = `<li>加载文章失败: ${error.message}</li>`;
          showStatus(`加载文章失败: ${error.message}`, true);
        }
      }

      async function showArticle(index) {
        try {
          // 高亮选中的文章
          const listItems = document.querySelectorAll('.article-list-item');
          listItems.forEach(item => item.classList.remove('active'));
          if (listItems[index]) {
            listItems[index].classList.add('active');
          }
          
          const article = articlesData[index];
          if (!article) return;
          
          const container = document.getElementById('article-container');
          container.innerHTML = `
            <div class="loading">
                <div class="loading-spinner"></div>
                <span>正在加载文章内容...</span>
            </div>`;
          
          console.log(`Loading content for article: ${article.title}, ID: ${article.id}`); // 调试输出
          
          // 使用页面 ID 获取内容
          const response = await fetch(`/api/article-content/${article.id}`);
          
          if (!response.ok) {
            const errorText = await response.text();
            console.error(`Failed to fetch article content: ${response.status} ${response.statusText}`, errorText);
            
            // 如果获取内容失败，显示一个链接到 Notion 页面
            container.innerHTML = `
              <h2 class="article-title">${article.title}</h2>
              <div class="article-body">
                <p>无法直接显示文章内容。可能是因为：</p>
                <ol>
                  <li>集成没有权限访问此页面</li>
                  <li>页面 ID 格式不正确</li>
                  <li>服务器连接问题</li>
                </ol>
                <p><a href="${article.url}" target="_blank">点击这里在 Notion 中查看文章</a></p>
              </div>
            `;
            
            showStatus(`加载文章内容失败: ${response.statusText}`, true);
            return;
          }
          
          const data = await response.json();
          console.log('Article content:', data); // 调试输出
          
          // 从页面数据中提取标题和属性
          let title = article.title;
          let properties = {};
          
          if (data.page && data.page.properties) {
            properties = data.page.properties;
            
            // 尝试从页面属性中获取标题
            if (properties.Name && properties.Name.title && properties.Name.title.length > 0) {
              title = properties.Name.title[0].plain_text || title;
            }
          }
          
          // 渲染文章内容
          let articleContent = renderNotionBlocks(data.results || []);
          
          // 如果没有内容，提供一个链接
          if (!articleContent || articleContent.trim() === '') {
            articleContent = `
              <p>无法直接显示文章内容。</p>
              <p><a href="${article.url}" target="_blank">点击这里在 Notion 中查看文章</a></p>
            `;
          }
          
          container.innerHTML = `
            <h2 class="article-title">${title}</h2>
            <div class="article-body">
              ${articleContent}
            </div>
          `;
          
          // 清空状态消息
          document.getElementById('status-message').textContent = '';
          
        } catch (error) {
          console.error('Error showing article:', error);
          const container = document.getElementById('article-container');
          const article = articlesData[index];
          
          container.innerHTML = `
            <h2 class="article-title">${article.title}</h2>
            <div class="article-body">
              <p>加载文章内容时出错: ${error.message}</p>
              <p><a href="${article.url}" target="_blank">点击这里在 Notion 中查看文章</a></p>
            </div>
          `;
          
          showStatus(`加载文章内容失败: ${error.message}`, true);
        }
      }

      // 渲染 Notion 块
      function renderNotionBlocks(blocks) {
        if (!blocks || !Array.isArray(blocks) || blocks.length === 0) {
          return '<p>没有内容</p>';
        }
        
        return blocks.map(block => {
          // 根据块类型渲染不同的 HTML
          switch (block.type) {
            case 'paragraph':
              return renderParagraph(block);
            case 'heading_1':
              return renderHeading(block, 'h1');
            case 'heading_2':
              return renderHeading(block, 'h2');
            case 'heading_3':
              return renderHeading(block, 'h3');
            case 'bulleted_list_item':
              return renderListItem(block, 'ul');
            case 'numbered_list_item':
              return renderListItem(block, 'ol');
            case 'to_do':
              return renderTodo(block);
            case 'toggle':
              return renderToggle(block);
            case 'code':
              return renderCode(block);
            case 'image':
              return renderImage(block);
            default:
              return `<div>不支持的块类型: ${block.type}</div>`;
          }
        }).join('');
      }

      // 渲染段落
      function renderParagraph(block) {
        if (!block.paragraph || !block.paragraph.rich_text) {
          return '<p></p>';
        }
        
        const text = block.paragraph.rich_text.map(richText => {
          return renderRichText(richText);
        }).join('');
        
        return `<p>${text || '&nbsp;'}</p>`;
      }

      // 渲染标题
      function renderHeading(block, tag) {
        if (!block[block.type] || !block[block.type].rich_text) {
          return `<${tag}></${tag}>`;
        }
        
        const text = block[block.type].rich_text.map(richText => {
          return renderRichText(richText);
        }).join('');
        
        return `<${tag}>${text || '&nbsp;'}</${tag}>`;
      }

      // 渲染列表项
      function renderListItem(block, listType) {
        if (!block[block.type] || !block[block.type].rich_text) {
          return `<li></li>`;
        }
        
        const text = block[block.type].rich_text.map(richText => {
          return renderRichText(richText);
        }).join('');
        
        return `<li>${text || '&nbsp;'}</li>`;
      }

      // 渲染待办事项
      function renderTodo(block) {
        if (!block.to_do || !block.to_do.rich_text) {
          return `<div class="todo"></div>`;
        }
        
        const text = block.to_do.rich_text.map(richText => {
          return renderRichText(richText);
        }).join('');
        
        const checked = block.to_do.checked ? 'checked' : '';
        
        return `
          <div class="todo">
            <input type="checkbox" ${checked} disabled>
            <span>${text || '&nbsp;'}</span>
          </div>
        `;
      }

      // 渲染折叠块
      function renderToggle(block) {
        if (!block.toggle || !block.toggle.rich_text) {
          return `<details><summary></summary></details>`;
        }
        
        const text = block.toggle.rich_text.map(richText => {
          return renderRichText(richText);
        }).join('');
        
        return `
          <details>
            <summary>${text || '&nbsp;'}</summary>
            <div>折叠内容</div>
          </details>
        `;
      }

      // 渲染代码块
      function renderCode(block) {
        if (!block.code || !block.code.rich_text) {
          return `<pre><code></code></pre>`;
        }
        
        const text = block.code.rich_text.map(richText => {
          return richText.plain_text;
        }).join('');
        
        const language = block.code.language || '';
        
        return `
          <pre><code class="language-${language}">${text || '&nbsp;'}</code></pre>
        `;
      }

      // 渲染图片
      function renderImage(block) {
        if (!block.image) {
          return `<div class="image-placeholder">图片</div>`;
        }
        
        let url = '';
        if (block.image.type === 'external') {
          url = block.image.external.url;
        } else if (block.image.type === 'file') {
          url = block.image.file.url;
        }
        
        if (!url) {
          return `<div class="image-placeholder">图片</div>`;
        }
        
        return `<img src="${url}" alt="图片" style="max-width: 100%;">`;
      }

      // 渲染富文本
      function renderRichText(richText) {
        if (!richText || !richText.plain_text) {
          return '';
        }
        
        let text = richText.plain_text;
        
        // 转义 HTML 特殊字符
        text = text
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#039;');
        
        // 应用文本样式
        if (richText.annotations) {
          if (richText.annotations.bold) {
            text = `<strong>${text}</strong>`;
          }
          if (richText.annotations.italic) {
            text = `<em>${text}</em>`;
          }
          if (richText.annotations.strikethrough) {
            text = `<del>${text}</del>`;
          }
          if (richText.annotations.underline) {
            text = `<u>${text}</u>`;
          }
          if (richText.annotations.code) {
            text = `<code>${text}</code>`;
          }
        }
        
        // 处理链接
        if (richText.href) {
          text = `<a href="${richText.href}" target="_blank">${text}</a>`;
        }
        
        return text;
      }

      // 页面加载完成后执行
      window.onload = function() {
        // 初始化数据库 ID 输入框
        document.getElementById('database-id').value = currentDatabaseId;
        
        // 加载文章
        loadArticles();
        
        // 添加调试模式开关事件
        document.getElementById('debug-mode-toggle').addEventListener('change', function(e) {
            const debugPanel = document.getElementById('debug-panel');
            debugPanel.style.display = e.target.checked ? 'block' : 'none';
            
            // 保存调试模式状态到 localStorage
            localStorage.setItem('debug-mode', e.target.checked);
        });
        
        // 从 localStorage 恢复调试模式状态
        const debugMode = localStorage.getItem('debug-mode') === 'true';
        document.getElementById('debug-mode-toggle').checked = debugMode;
        document.getElementById('debug-panel').style.display = debugMode ? 'block' : 'none';
        
        // 添加更新配置按钮事件
        document.getElementById('update-config-btn').addEventListener('click', function() {
          if (updateConfig()) {
            loadArticles();
          }
        });
        
        // 添加集成指南显示/隐藏事件
        document.getElementById('show-integration-guide').addEventListener('click', function(e) {
          e.preventDefault();
          document.getElementById('integration-guide').style.display = 'block';
        });
        
        // 添加刷新按钮事件
        document.getElementById('refresh-btn').addEventListener('click', loadArticles);
        
        // 添加调试按钮事件
        document.getElementById('debug-btn').addEventListener('click', async function() {
          try {
            if (!updateConfig()) return;
            
            showStatus('正在获取数据库信息...');
            const response = await fetch(`/api/database-info?id=${currentDatabaseId}`);
            if (!response.ok) {
              const errorText = await response.text();
              console.error(`API request failed: ${response.status} ${response.statusText}`, errorText);
              throw new Error(`API request failed with status ${response.status}: ${errorText}`);
            }
            const data = await response.json();
            console.log('Database Info:', data);
            showStatus('数据库信息已在控制台输出');
            alert('数据库信息已在控制台输出');
          } catch (error) {
            console.error('Error fetching database info:', error);
            showStatus(`获取数据库信息失败: ${error.message}`, true);
            alert(`获取数据库信息失败: ${error.message}`);
          }
        });
        
        // 添加测试 API 连接按钮事件
        document.getElementById('test-api-btn').addEventListener('click', async function() {
          try {
            showStatus('正在测试 API 连接...');
            const response = await fetch('/api/notion-test');
            if (!response.ok) {
              const errorText = await response.text();
              console.error(`API test failed: ${response.status} ${response.statusText}`, errorText);
              throw new Error(`API test failed with status ${response.status}: ${errorText}`);
            }
            const data = await response.json();
            console.log('API Test Result:', data);
            showStatus('API 连接测试成功');
            alert('API 连接测试成功，详情请查看控制台');
          } catch (error) {
            console.error('Error testing API:', error);
            showStatus(`API 连接测试失败: ${error.message}`, true);
            alert(`API 连接测试失败: ${error.message}`);
          }
        });
        
        // 添加列出数据库按钮事件
        document.getElementById('list-db-btn').addEventListener('click', async function() {
          try {
            showStatus('正在获取数据库列表...');
            const response = await fetch('/api/databases');
            if (!response.ok) {
              const errorText = await response.text();
              console.error(`Failed to list databases: ${response.status} ${response.statusText}`, errorText);
              throw new Error(`Failed to list databases with status ${response.status}: ${errorText}`);
            }
            const data = await response.json();
            console.log('Databases:', data);
            
            let dbInfo = '找到的数据库:\n\n';
            if (data.results && data.results.length > 0) {
              data.results.forEach((db, index) => {
                let title = '无标题';
                
                // 尝试从不同属性中获取标题
                if (db.title && Array.isArray(db.title) && db.title.length > 0) {
                  title = db.title[0].plain_text || title;
                } else if (db.properties && db.properties.title) {
                  title = '数据库 ' + (index + 1);
                }
                
                dbInfo += `${index + 1}. ${title} (ID: ${db.id})\n`;
              });
            } else {
              dbInfo += '没有找到数据库';
            }
            
            showStatus(`已找到 ${data.results ? data.results.length : 0} 个数据库`);
            alert(dbInfo);
          } catch (error) {
            console.error('Error listing databases:', error);
            showStatus(`获取数据库列表失败: ${error.message}`, true);
            alert(`获取数据库列表失败: ${error.message}`);
          }
        });
      };
    </script>
</body>
</html> 